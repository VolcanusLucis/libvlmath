name: CodeQL
on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
    
jobs:
  codeql:
    permissions:
      security-events: write
      packages: read
      
    strategy: 
      fail-fast: true

      matrix:
        language: [ c-cpp, actions ]
        build-mode: [ none, autobuild ]
        exclude:
        - language: c-cpp
          build-mode: none
        - language: actions
          build-mode: autobuild
    
    uses: VolcanusLucis/.github/.github/workflows/shared-codeql.yml@feature/7-add-shared-codeql-workflow
    with:
      language: ${{ matrix.language }}
      build-mode: ${{ matrix.build-mode }}
    
  run-codeql:
    if: always()
    runs-on: ubuntu-latest
    needs: codeql
    steps:
      # https://github.com/orgs/community/discussions/26822
      - if: ${{ contains(needs.*.result, 'failure')
          || contains(needs.*.result, 'cancelled')
          || contains(needs.*.result, 'skipped') }}
        run: exit 1
