name: CodeQL
on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
    
jobs:
  initialise:
    permissions:
      contents: read
      
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: echo "workspace=${{ github.workspace }}" >> $GITHUB_ENV
          
          
  
  codeql:
    permissions:
      security-events: write
      packages: read
      
    strategy: 
      fail-fast: true

      matrix:
        include:
          - language: c-cpp
            build-mode: manual
            manual-command-list: > 
              cmake -S ${{ env.workspace }} -B ${{ env.workspace }}/build -G "Ninja Multi-Config"
              -DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++ -DCMAKE_CXX_FLAGS="-O3 -Wall -std=c++23"
              
              cmake --build ${{ env.workspace }}/build --config Release
          
          - language: actions
            build-mode: none
    
    uses: VolcanusLucis/.github/.github/workflows/shared-codeql.yml@feature/7-add-shared-codeql-workflow
    with:
      language: ${{ matrix.language }}
      build-mode: ${{ matrix.build-mode }}
      manual-command-list: ${{ matrix.manual-command-list }}
    
  run-codeql:
    if: always()
    runs-on: ubuntu-latest
    needs: codeql
    steps:
      # https://github.com/orgs/community/discussions/26822
      - if: ${{ contains(needs.*.result, 'failure')
          || contains(needs.*.result, 'cancelled')
          || contains(needs.*.result, 'skipped') }}
        run: exit 1
